{% extends 'base.html' %}

{% block title %}Forex Â· Travel Expense Tracker{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-1">Forex Cards</h1>
<p class="text-slate-400 text-sm mb-6">Loaded vs spent amounts and low balance indicators.</p>

{% include 'partials/_form_errors.html' with context %}
{% if messages.get('forex_success') %}
<div class="mb-5 rounded-md border border-emerald-600/50 bg-emerald-900/40 px-4 py-3 text-sm">
    <strong class="text-emerald-300">Forex card updated!</strong>
    <span class="block text-emerald-200 mt-1">{{ messages.forex_success }}</span>
</div>
{% endif %}

<!-- Create/Update Forex Load Form -->
<section class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 mb-8">
    <h2 class="text-[0.75rem] font-semibold uppercase tracking-wide text-slate-300 mb-3">Load Forex Card</h2>
    <p class="text-[11px] text-slate-400 mb-4">Set or update the loaded amount for a forex card. This replaces the
        current loaded value.</p>

    <form method="post" action="/ui/forex" class="grid gap-4 max-w-md">
        <div>
            <label class="block text-xs font-semibold tracking-wide text-slate-400 uppercase mb-1" for="currency">
                Currency *
            </label>
            <select
                class="w-full bg-slate-900/60 border border-slate-700 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500"
                id="currency" name="currency" required>
                <option value="">-- choose --</option>
                {% for c in forex_currencies %}
                <option value="{{ c }}" {% if form.currency==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-xs font-semibold tracking-wide text-slate-400 uppercase mb-1" for="loaded_amount">
                Loaded Amount *
            </label>
            <input
                class="w-full bg-slate-900/60 border border-slate-700 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500"
                id="loaded_amount" name="loaded_amount" type="number" step="0.01" min="0.01" required
                value="{{ form.loaded_amount or '' }}" placeholder="e.g., 1000.00" />
            <p class="text-[10px] text-slate-500 mt-1">Enter the total amount loaded on the card (replaces existing
                value).</p>
        </div>

        <div class="flex items-center gap-4 pt-1">
            <button
                class="inline-flex items-center gap-1 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600/40 disabled:cursor-not-allowed text-white font-medium text-sm px-5 py-2 rounded-md shadow-sm transition-colors"
                type="submit">
                Set Loaded Amount
            </button>
        </div>
    </form>
</section>

<section class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 mb-8">
    <h2 class="text-[0.75rem] font-semibold uppercase tracking-wide text-slate-300 mb-3">Summary</h2>
    {% if cards %}
    <div class="flex flex-wrap gap-4 text-[11px] text-slate-300">
        <div><span class="font-semibold">Total Cards:</span> {{ cards|length }}</div>
        <div class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Low Balance (
            <20%): {{ low_cards|length }}</div>
        </div>
        {% else %}
        <p class="text-[11px] text-slate-500">No forex cards configured yet. Use the form to create/update loads.</p>
        {% endif %}
</section>

<section>
    <h2 class="text-[0.75rem] font-semibold uppercase tracking-wide text-slate-300 mb-3">Details</h2>
    {% if cards %}
    <div class="overflow-x-auto -mx-2">
        <table class="w-full text-xs min-w-[540px] mx-2 border-separate border-spacing-y-1">
            <thead>
                <tr class="text-[10px] uppercase tracking-wide text-slate-400">
                    <th class="text-left font-medium">Currency</th>
                    <th class="text-right font-medium">Loaded</th>
                    <th class="text-right font-medium">Spent</th>
                    <th class="text-right font-medium">Remaining</th>
                    <th class="text-right font-medium">% Rem</th>
                    <th class="text-left font-medium">Status</th>
                </tr>
            </thead>
            <tbody class="text-[11px]">
                {% for c in cards %}
                <tr
                    class="odd:bg-slate-800/40 hover:bg-slate-700/40 transition-colors {{ 'outline outline-1 outline-red-600/40' if c.low_balance else '' }}">
                    <td class="py-1 pr-2 font-medium text-slate-200">{{ c.currency }}</td>
                    <td class="text-right py-1 pr-2">{{ '%.2f' % c.loaded_amount }}</td>
                    <td class="text-right py-1 pr-2">{{ '%.2f' % c.spent_amount }}</td>
                    <td class="text-right py-1 pr-2">{{ '%.2f' % c.remaining }}</td>
                    <td class="text-right py-1 pr-2">{{ '%.2f' % c.percent_remaining }}%</td>
                    <td class="py-1 pr-2">
                        {% if c.low_balance %}
                        <span
                            class="inline-flex items-center gap-1 rounded-full bg-red-600 text-white px-2 py-0.5 text-[10px] font-semibold">
                            <span class="w-1.5 h-1.5 rounded-full bg-white/70 animate-pulse"></span> Low
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center gap-1 rounded-full bg-green-600/70 text-white px-2 py-0.5 text-[10px] font-semibold">
                            <span class="w-1.5 h-1.5 rounded-full bg-white/40"></span> OK
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-[11px] text-slate-500">No data to display.</p>
    {% endif %}
</section>

<section class="mt-10 bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60">
    <h2 class="text-[0.75rem] font-semibold uppercase tracking-wide text-slate-300 mb-3">Legend</h2>
    <ul class="list-disc ml-5 text-[11px] text-slate-400 space-y-1">
        <li><span class="font-medium text-green-300">OK</span>: Remaining balance is >=20% of loaded amount.</li>
        <li><span class="font-medium text-red-300">Low</span>: Remaining balance &lt;20% of loaded amount (strictly less
            than).</li>
    </ul>
</section>

{% endblock %}