{% extends 'base.html' %}
{% import 'partials/_components.html' as c %}

{% block title %}Dashboard · Travel Expense Tracker{% endblock %}

{% block content %}
{% set trip = active_trip %}
<div class="flex flex-wrap items-start justify-between gap-4 mb-6">
    <div class="space-y-1">
        <h1 class="text-xl font-semibold">Dashboard</h1>
        <p class="text-slate-400 text-sm">
            {% if trip %}
            Snapshot for <span class="text-slate-200 font-semibold">{{ trip.name }}</span>
            {% else %}
            Snapshot of trip finances.
            {% endif %}
        </p>
    </div>
    {% if trip %}
    <div
        class="bg-slate-800/80 border border-slate-700/70 rounded-lg px-4 py-3 text-xs sm:text-sm text-slate-200 shadow-sm min-w-[240px]">
        <div class="flex items-center gap-2">
            <span class="text-[11px] uppercase tracking-wide text-slate-400">Status</span>
            <span
                class="px-2 py-0.5 rounded-full text-[11px] font-semibold uppercase tracking-wide {{ 'bg-emerald-600/70 text-emerald-100' if trip.status == 'active' else 'bg-slate-600/80 text-slate-100' }}">{{ trip.status }}</span>
        </div>
        <div class="mt-2 grid grid-cols-2 gap-3 text-[11px] sm:text-xs">
            <div>
                <div class="uppercase tracking-wide text-slate-400">Start</div>
                <div class="text-slate-100">{{ trip.start_date or 'Not set' }}</div>
            </div>
            <div>
                <div class="uppercase tracking-wide text-slate-400">End</div>
                <div class="text-slate-100">{{ trip.end_date or 'Not set' }}</div>
            </div>
            <div>
                <div class="uppercase tracking-wide text-slate-400">Expenses</div>
                <div class="text-slate-100">₹ {{ '%.2f'|format(avg.total_inr) }}</div>
            </div>
            <div>
                <div class="uppercase tracking-wide text-slate-400">Budgets Tracked</div>
                <div class="text-slate-100">{{ budgets|length }}</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% include 'partials/_alerts.html' %}

<section class="grid gap-4 sm:gap-5 md:grid-cols-3 mb-6 auto-rows-fr">
    <div
        class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 hover:border-slate-600/60 transition-colors">
        <h2 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-2">Average Daily Spend</h2>
        <div class="text-2xl font-semibold">₹ {{ '%.2f'|format(avg.average_daily_spend) }}</div>
        <div class="text-[11px] text-slate-400 mt-1">
            {% if avg.days_elapsed > 0 %}
            Total: ₹ {{ '%.2f'|format(avg.total_inr) }} over {{ avg.days_elapsed }} day{{ '' if avg.days_elapsed == 1 else 's' }}
            {% else %}
            No spend recorded yet for this trip.
            {% endif %}
        </div>
    </div>
    <div
        class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 hover:border-slate-600/60 transition-colors">
        <h2 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-2">Remaining Daily Budget</h2>
        <div class="text-2xl font-semibold">₹ {{ '%.2f'|format(remaining.remaining_daily_budget) }}</div>
        <div class="text-[11px] text-slate-400 mt-1">
            {% if remaining.days_left > 0 and remaining.remaining_inr > 0 %}
            Remaining: ₹ {{ '%.2f'|format(remaining.remaining_inr) }} across {{ remaining.days_left }} day{{ '' if remaining.days_left == 1 else 's' }}
            {% elif remaining.days_left <= 0 %}
            Trip end date has passed. Remaining budget calculated as ₹ {{ '%.2f'|format(remaining.remaining_inr) }}.
            {% else %}
            No INR budget configured for this trip.
            {% endif %}
        </div>
    </div>
    <div
        class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 hover:border-slate-600/60 transition-colors">
        <h2 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-2">Exchange Rates</h2>
        <ul class="list-none p-0 m-0 text-xs space-y-0.5">
            {% for r in rates %}<li>1 {{ r.currency }} = ₹ {{ r.rate }}</li>{% endfor %}
        </ul>
        <div class="text-[10px] text-slate-500 mt-2">Cached (may refresh hourly)</div>
    </div>
</section>

<section class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60 mb-6">
    <h2 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-3">Budgets</h2>
    {% if budgets %}
    <div>
        {% for b in budgets %}
        {{ c.progress_bar(b.percent_used, b.currency ~ ' • ₹' ~ '%.2f'|format(b.spent_amount) ~ ' / ' ~ '%.2f'|format(b.max_amount), warn=b.eighty and
        not b.ninety, danger=b.ninety) }}
        {% endfor %}
    </div>
    {% else %}
    <p class="text-xs text-slate-500">No budgets configured for this trip.</p>
    {% endif %}
</section>

<section class="grid gap-4 sm:gap-5 md:grid-cols-2">
    <div class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60">
        <h3 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-2">Currency Breakdown</h3>
        {% if currency_breakdown %}
        <div class="sm:overflow-x-visible overflow-x-auto mt-2 mb-1">
            <table class="w-full text-xs min-w-[340px] border-separate border-spacing-y-1">
                <thead>
                    <tr class="text-[10px] uppercase tracking-wide text-slate-400">
                        <th class="text-left font-medium">Currency</th>
                        <th class="text-right font-medium">INR Total</th>
                        <th class="text-right font-medium">% INR</th>
                    </tr>
                </thead>
                <tbody class="text-[11px]">
                    {% for item in currency_breakdown %}
                    <tr class="odd:bg-slate-800/40 hover:bg-slate-700/40 transition-colors">
                        <td class="py-1 pr-2">{{ item.currency }}</td>
                        <td class="text-right py-1 pr-2">₹ {{ '%.2f'|format(item.inr_total) }}</td>
                        <td class="text-right py-1 pr-2">{{ item.percent_inr }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-[11px] text-slate-500">No spend recorded yet for this trip.</p>
        {% endif %}
    </div>
    <div class="bg-slate-800/70 rounded-lg p-4 shadow-sm border border-slate-700/60">
        <h3 class="text-[0.8rem] font-semibold uppercase tracking-wide text-slate-300 mb-2">Category Breakdown</h3>
        {% if category_breakdown %}
        <div class="sm:overflow-x-visible overflow-x-auto mt-2 mb-1">
            <table class="w-full text-xs min-w-[340px] border-separate border-spacing-y-1">
                <thead>
                    <tr class="text-[10px] uppercase tracking-wide text-slate-400">
                        <th class="text-left font-medium">Category</th>
                        <th class="text-right font-medium">INR</th>
                        <th class="text-right font-medium">%</th>
                    </tr>
                </thead>
                <tbody class="text-[11px]">
                    {% for item in category_breakdown %}
                    <tr class="odd:bg-slate-800/40 hover:bg-slate-700/40 transition-colors">
                        <td class="py-1 pr-2">{{ item.category }}</td>
                        <td class="text-right py-1 pr-2">₹ {{ '%.2f'|format(item.inr_total) }}</td>
                        <td class="text-right py-1 pr-2">{{ item.percent }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-[11px] text-slate-500">No spend recorded yet for this trip.</p>
        {% endif %}
    </div>
</section>

{% endblock %}
